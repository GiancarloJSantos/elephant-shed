{% macro clusterctl_js() -%}
<script>

function clear_stateclasses(x){
	$(x).removeClass("request-waiting");
	$(x).removeClass("request-success");
	$(x).removeClass("request-fail");
};


function log(msg){
	var l =  $('#pg_log');
	//console.log(l);
	//l.prepend('<div class="message">'+msg+'</div>');
}


function issue_clustercall( host, version, cluster, method, data, call_success, call_fail ){
	var deeplink = ''
	if (version && cluster) {	deeplink = '/'+version+'/'+cluster; }
	$.ajax({url: '{{ url_for("index") }}pgapi/proxy/cluster/'+host+deeplink,
	method: method,
	data: data,
	contentType: "application/json; charset=utf-8",
	success: call_success,
	error: call_fail,
	});
}
function issue_systemcall( host, argument, call_success, call_fail ){
	var deeplink = ''
	if (argument) {	deeplink = '/'+argument; }

	$.ajax({url: '{{ url_for("index") }}pgapi/proxy/system/'+host+deeplink,
	method: 'get',
	//data: data,
	contentType: "application/json; charset=utf-8",
	success: call_success,
	error: call_fail,
	});
}


function pg_ctl( obj ) {
//(x, host, version, cluster, action, call_success, call_fail ){
var x = obj.x;
var host = obj.host;
var version = obj.version;
var cluster = obj.cluster;
var action = obj.action;
var call_success = obj.call_success;
var call_fail = obj.call_fail;
var rest_args = obj.data ? obj.data : {} ;
var rest_method;

if ( $.inArray( action.toLowerCase(), ["start","stop","reload","restart"] )!= -1 ){
	rest_args['state'] = action;
	rest_method = 'PATCH'}
else if ( action == 'ls') {	
	rest_method = 'GET';}
else if ( action == 'create') {	
	rest_method = 'POST';}
else if ( action == 'remove') {	
	rest_method = 'DELETE';}
else if ( action == 'config-only'){
	rest_method = 'PATCH';
	}
else if ( action == 'ls-system' ){
	// Magic specialcase
	issue_systemcall( host, undefined, call_success, call_fail );
	return;
	}
else { console.log("pg_ctl call does not support this action! Action was '"+action+"'") }
console.log(rest_args);
clear_stateclasses(x);
$(x).addClass("request-waiting");

issue_clustercall( host, version, cluster, rest_method,  JSON.stringify(rest_args) ,
		//call_success ? call_success : 
		function( data ){ 
		$(x).removeClass("request-waiting");
	 	$(x).addClass("request-success");
		if (call_success){ call_success(data) };
		},
		//call_fail ? call_fail :
		function( request,status,err ){
		var errmsg = '';
		try { errmsg = request.responseJSON['stderr'];}
		catch(e){;};

		push_notification( err + ' : '+ errmsg );
		$(x).removeClass("request-waiting");
	 	$(x).addClass("request-fail");
		if (call_fail){call_fail(request,status,err) };
		});
}

function inputvalues_to_dict(lowerthan){
	var data = {};
	$(lowerthan).find('input[type=checkbox]:not(.formignore)').each(function(index){
		var element = $(this);
		var value = $(element).prop('checked');
		data[element.val() ]=value;
	} );
	$(lowerthan).find('input[type=text]:not(.formignore)').each(function(index){
		var element = $(this);
		var value = $(element).val();
		if (value != ''){data[element.attr('name') ]=value;};
	} );
	console.log(data);
	return data;

}

function update_conf( x, host, version, cluster ) {
	var newName = $(x).closest('tr').find('.config-name').val();
	var newValue= $(x).closest('tr').find('.config-value').val();
	var restArgs = { config : { } };
	restArgs['config'][newName] = newValue;
	console.log(restArgs);
	pg_ctl({ x:x,
		host: host,
		version: version, 
		cluster: cluster, 
		action :'config-only', 
		data : restArgs ,
		call_success: fill_details });
}

function goto_dash(){document.location.href= '{{ url_for("index") }}';  }


function fill_details( details, host) {
	$('.state-disable-for-online').prop('disabled',false);
	$('.state-disable-for-offline').prop('disabled',false);
	$('.state-disable-for-recovery').prop('disabled',false);
	$('.state-disable-for-no-recovery').prop('disabled',false);


	var runstate = '';
	if ( details['running'] == 1 ){
		runstate='online';
		$('.state-disable-for-online').prop('disabled',true);
	}
	else{ runstate='offline';	
		$('.state-disable-for-offline').prop('disabled',true);
	}
	if ( details['recovery'] == 1 ){
		runstate+=' in recovery';
		$('.state-disable-for-no-recovery').prop('disabled',true);
	}
	function recurse(stack, data){
		for ( var key in data ){
			var selector_key = stack+'.pg_'+key.replace(/\//g,'_s_');
			if (data[key] instanceof Object ){
					recurse(selector_key, data[key] )
				}
			else{
				var value=data[key];
				if ( ['free','total','used','active','available'].indexOf( key )  != -1 ){
					value=bytes_prettyprint( value ) ;
				}
				if ( $(selector_key).length <= 0 && selector_key.indexOf('pg_config') != -1 ){ 
		   			console.log("unknown "+selector_key);
		   			console.log( $(selector_key).length);
		   			$('<tr class="hidden_config" hidden><td>'+key+'</td><td><span class="'+selector_key.replace(/(\.)/g,' ')+'"></span></td></tr>').insertBefore(".below_hidden_config");
				}
				$(selector_key).html( value ); 
				$(selector_key).closest('tr').removeClass("es_disabled");
				console.log(selector_key);
				}
		};
	}
	recurse('',details);
	if ( host ) {$('.pg_hostname').html( host ) ; }
	$('.pg_state').html( runstate);
	
}

function get_host( hosturl, clustername, clusterversion){
	pg_ctl({host: hosturl, 
			cluster : clustername, 
			version: clusterversion, 
			action: 'ls', 
			call_success: function(result){ fill_details( result, hosturl )  },
			call_fail: function(){ alert('BAD');},

	 });
	pg_ctl({host: hosturl, 
			cluster : clustername, 
			version: clusterversion, 
			action: 'ls-system', 
			call_success: function(result){ fill_details( result, hosturl )  },
			call_fail: function(){ alert('BAD');},
	 });

	};


function querybar_hide_and_reset(){
	setTimeout(function(){
		$('#querying_hosts_div').css('height',0);
		$('#querying_hosts_bar').css("width","0%");
		$('#querying_hosts_bar_error').css("width","0%");
		}, 500);
	}

function querybar_get(){
	var querybar = {
		bar: '#querying_hosts_div',
		success : '#querying_hosts_bar',
		fail : '#querying_hosts_bar_error',
	};
	return querybar;
}
function querybar_set_numelements( numelements ){
	$('#querybar_elements').attr( 'numElements', numelements );
}
function querybar_get_numelements( ){
	return $('#querybar_elements').attr('numElements');
}

function querybar_hide_if_full(){
	var querybar = querybar_get();
 	if ( (Number($(querybar.fail).attr("aria-valuenow")) + 	
	Number($(querybar.success).attr("aria-valuenow")))  >=99)
	{querybar_hide_and_reset() }
}

function querybar_reset_and_init(){
	var querybar = querybar_get();

	$(querybar.bar).css("transition","0s all");
	$(querybar.success).css("width","0%");
	$(querybar.fail).css("width","0%");

	$(querybar.success).attr("aria-valuenow","0");
	$(querybar.fail).attr("aria-valuenow","0");

	$(querybar.bar).css("transition","0.2s all");
	$(querybar.bar).css('height',3);
	return querybar;
}

function querybar_add_fail(){
	var querybar = querybar_get();
 
	$(querybar.fail).attr("aria-valuenow", 
		Number($(querybar.fail).attr("aria-valuenow")) + 100 / Number(querybar_get_numelements())
		);
	$(querybar.fail).css("width", $(querybar.fail).attr("aria-valuenow") + "%");
	querybar_hide_if_full();
}
function querybar_add_success(){
	var querybar = querybar_get();
 
	$(querybar.success).attr("aria-valuenow", 
		Number($(querybar.success).attr("aria-valuenow")) + 100 / Number(querybar_get_numelements())
		);
	$(querybar.success).css("width", $(querybar.success).attr("aria-valuenow") + "%");
	querybar_hide_if_full();
}

function bytes_prettyprint(number){
	var num = Number(number);
	var sizes = ['','k','M','G','T'];
	var iterations = 0;
	while (num >= 10000){
		num = num/1024;
		iterations += 1;
	}
	return Math.floor(num)+sizes[iterations]+'B';
}

function add_detail_graphs(){
	console.log(   $('.pg_addgraph').closest('td') ) ;
	$('.pg_addgraph').closest('td').append('<div class="pg_chart" style="float: right"></div>');
	$('.pg_chart').each( function(){
		var randomspeed = 1+Math.random();
		var plotdata= [[ { x: 0, y: 0 },]];
		var graph = new Rickshaw.Graph( {
    			element: this, 
    			width: 200,
    			height: 15,
    			renderer: 'bar', 
    			series: 
				new Rickshaw.Series.FixedDuration([{
					name: 'default',
        				color: 'lightblue',
	       				//data: plotdata[0],
					}],
					//new Rickshaw.Color.Palette(
					//	{ scheme: 'spectrum2001', interpolatedStopCount: 100 }),
					undefined,
					{
					maxDataPoints: 500,
					timeInterval: 1000,
					})
			});
			graph.render();
		function insertDummy(){
			console.log(  Math.sin( (new Date).getTime() )  ) ;
			graph.series.addData(
					//{ x: plotdata[0][plotdata[0].length -1]['x']+1, y: Math.random()*2}
					{ 'default' : Math.sin( (new Date).getTime()*0.0001*randomspeed )+1   }
					);
			graph.update();
			setTimeout ( function(){
				insertDummy();
			}, 1000);
			};
		insertDummy();
	});
};



</script>


{%- endmacro %}
